<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المجموعة - نظام الإحالة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="user-info">
                <img id="user-avatar" src="https://ui-avatars.com/api/?name=مستخدم&background=random" alt="صورة المستخدم">
                <span id="username">مستخدم</span>
            </div>
            <h1><i class="fas fa-users-cog"></i> إدارة المجموعة</h1>
            <p>إدارة وتتبع أعضاء شبكتك بشكل كامل</p>
        </header>
        
        <div class="tabs">
            <div class="tab" onclick="window.location.href='index.html'">الرئيسية</div>
            <div class="tab" onclick="window.location.href='dashboard.html'">لوحة التحكم</div>
            <div class="tab" onclick="window.location.href='network.html'">شبكتي</div>
            <div class="tab active">الإدارة</div>
            <div class="tab" id="logout-btn">تسجيل الخروج</div>
        </div>
        
        <div class="tab-content active">
            <h2>إدارة أعضاء الشبكة</h2>
            <p>من هنا يمكنك إدارة جميع أفراد شبكتك وتتبع أدائهم.</p>
            
            <div class="filters">
                <select class="filter-select" id="level-filter">
                    <option value="">جميع المستويات</option>
                    <option value="1">المستوى 1</option>
                    <option value="2">المستوى 2</option>
                    <option value="3">المستوى 3</option>
                    <option value="4">المستوى 4</option>
                    <option value="5">المستوى 5</option>
                </select>
                
                <select class="filter-select" id="status-filter">
                    <option value="">جميع الحالات</option>
                    <option value="active">نشط</option>
                    <option value="inactive">غير نشط</option>
                </select>
                
                <input type="date" id="date-from" class="filter-date">
                <input type="date" id="date-to" class="filter-date">
                
                <input type="text" id="search-input" placeholder="ابحث بالاسم أو البريد">
                
                <button id="apply-filters"><i class="fas fa-filter"></i> تطبيق الفلتر</button>
                <button id="export-btn"><i class="fas fa-download"></i> تصدير البيانات</button>
            </div>
            
            <div class="stats-summary">
                <div class="stat-item">
                    <span class="stat-label">إجمالي الأعضاء:</span>
                    <span class="stat-value" id="total-members">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">أعضاء نشطون:</span>
                    <span class="stat-value" id="active-members">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">النقاط المجمعة:</span>
                    <span class="stat-value" id="total-points">0</span>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="referrals-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم <button class="sort-btn" data-sort="name"><i class="fas fa-sort"></i></button></th>
                            <th>البريد الإلكتروني</th>
                            <th>المستوى <button class="sort-btn" data-sort="level"><i class="fas fa-sort"></i></button></th>
                            <th>تاريخ الانضمام <button class="sort-btn" data-sort="joinDate"><i class="fas fa-sort"></i></button></th>
                            <th>الإحالات <button class="sort-btn" data-sort="referrals"><i class="fas fa-sort"></i></button></th>
                            <th>النقاط <button class="sort-btn" data-sort="points"><i class="fas fa-sort"></i></button></th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="network-members">
                        <tr>
                            <td colspan="9" style="text-align: center;">جاري تحميل البيانات...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="pagination">
                <button id="prev-page" disabled><i class="fas fa-chevron-right"></i> السابق</button>
                <span id="pagination-info">الصفحة 1 من 1</span>
                <button id="next-page" disabled>التالي <i class="fas fa-chevron-left"></i></button>
                <select id="page-size">
                    <option value="10">10 لكل صفحة</option>
                    <option value="25">25 لكل صفحة</option>
                    <option value="50">50 لكل صفحة</option>
                    <option value="100">100 لكل صفحة</option>
                </select>
            </div>
        </div>
    </div>

    <!-- نموذج تعديل العضو -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>تعديل بيانات العضو</h3>
            <form id="edit-member-form">
                <input type="hidden" id="edit-member-id">
                <div class="form-group">
                    <label for="edit-name">الاسم</label>
                    <input type="text" id="edit-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-email">البريد الإلكتروني</label>
                    <input type="email" id="edit-email" required>
                </div>
                <div class="form-group">
                    <label for="edit-points">النقاط</label>
                    <input type="number" id="edit-points" min="0" required>
                </div>
                <div class="form-group">
                    <label for="edit-status">الحالة</label>
                    <select id="edit-status">
                        <option value="active">نشط</option>
                        <option value="inactive">غير نشط</option>
                    </select>
                </div>
                <button type="submit">حفظ التغييرات</button>
            </form>
        </div>
    </div>

    <script type="module" src="app.js"></script>
    <script src="management.js"></script>
</body>
</html>-filter').value = '';
    document.getElementById('date-from').value = '';
    document.getElementById('date-to').value = '';
    document.getElementById('search-input').value = '';
    
    this.currentPage = 1;
    this.renderManagementTable();
  }

  applyFiltersToMembers(members) {
    const levelFilter = document.getElementById('level-filter').value;
    const statusFilter = document.getElementById('status-filter').value;
    const dateFrom = document.getElementById('date-from').value;
    const dateTo = document.getElementById('date-to').value;
    const searchText = document.getElementById('search-input').value.toLowerCase();
    
    return members.filter(member => {
      // تصفية حسب المستوى
      if (levelFilter && member.level != levelFilter) return false;
      
      // تصفية حسب الحالة
      if (statusFilter && member.status !== statusFilter) return false;
      
      // تصفية حسب التاريخ
      if (dateFrom && new Date(member.joinDate) < new Date(dateFrom)) return false;
      if (dateTo && new Date(member.joinDate) > new Date(dateTo)) return false;
      
      // تصفية حسب البحث
      if (searchText && 
          !member.name.toLowerCase().includes(searchText) && 
          !member.email.toLowerCase().includes(searchText)) {
        return false;
      }
      
      return true;
    });
  }

  sortMembers(members, field, direction) {
    return members.sort((a, b) => {
      let valueA = a[field];
      let valueB = b[field];
      
      // معالجة التواريخ
      if (field === 'joinDate') {
        valueA = new Date(valueA);
        valueB = new Date(valueB);
      }
      
      // المقارنة
      if (valueA < valueB) {
        return direction === 'asc' ? -1 : 1;
      }
      if (valueA > valueB) {
        return direction === 'asc' ? 1 : -1;
      }
      return 0;
    });
  }

  toggleSortOrder(button, field) {
    const icon = button.querySelector('i');
    
    // تبديل اتجاه الترتيب
    if (this.currentSort.field === field) {
      this.currentSort.direction = this.currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
      this.currentSort.field = field;
      this.currentSort.direction = 'asc';
    }
    
    // تحديث الأيقونة
    icon.className = this.currentSort.direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
    
    // إعادة تعيين أيقونات الأزرار الأخرى
    document.querySelectorAll('.sort-btn i').forEach(otherIcon => {
      if (otherIcon !== icon) {
        otherIcon.className = 'fas fa-sort';
      }
    });
    
    // تطبيق الترتيب
    this.renderManagementTable();
  }

  goToPrevPage() {
    if (this.currentPage > 1) {
      this.currentPage--;
      this.renderManagementTable();
    }
  }

  goToNextPage() {
    const totalPages = Math.ceil(this.filteredMembers.length / this.pageSize);
    if (this.currentPage < totalPages) {
      this.currentPage++;
      this.renderManagementTable();
    }
  }

  changePageSize() {
    this.pageSize = parseInt(document.getElementById('page-size').value);
    this.currentPage = 1;
    this.renderManagementTable();
  }

  updatePagination(totalPages) {
    document.getElementById('pagination-info').textContent = `الصفحة ${this.currentPage} من ${totalPages}`;
    
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    
    prevBtn.disabled = this.currentPage === 1;
    nextBtn.disabled = this.currentPage === totalPages || totalPages === 0;
  }

  updateStats() {
    const totalMembers = this.allMembers.length;
    const activeMembers = this.allMembers.filter(m => m.status === 'active').length;
    const totalPoints = this.allMembers.reduce((sum, m) => sum + (m.points || 0), 0);
    
    if (document.getElementById('total-members')) {
      document.getElementById('total-members').textContent = totalMembers;
    }
    if (document.getElementById('active-members')) {
      document.getElementById('active-members').textContent = activeMembers;
    }
    if (document.getElementById('total-points')) {
      document.getElementById('total-points').textContent = totalPoints;
    }
  }

  exportData() {
    // تصدير البيانات إلى CSV
    const headers = ['الاسم', 'البريد الإلكتروني', 'المستوى', 'تاريخ الانضمام', 'الإحالات', 'النقاط', 'الحالة'];
    const data = this.filteredMembers.map(member => [
      member.name,
      member.email,
      member.level,
      new Date(member.joinDate).toLocaleDateString('ar-SA'),
      member.referralsCount || 0,
      member.points || 0,
      member.status === 'active' ? 'نشط' : 'غير نشط'
    ]);
    
    let csvContent = headers.join(',') + '\n';
    data.forEach(row => {
      csvContent += row.join(',') + '\n';
    });
    
    const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', 'أعضاء_الشبكة.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  showAddPointsModal(userId) {
    if (!app.userData || !app.userData.isAdmin) return;
    
    const modal = document.getElementById('add-points-modal');
    if (modal) {
      modal.style.display = 'block';
      document.getElementById('points-user-id').value = userId;
      
      // تحميل بيانات المستخدم
      app.getUserDetails(userId).then(userData => {
        if (userData) {
          document.getElementById('points-user-name').textContent = userData.name;
        }
      });
    }
  }

  async addPointsToUser() {
    if (!app.userData || !app.userData.isAdmin) return;
    
    const userId = document.getElementById('points-user-id').value;
    const points = parseInt(document.getElementById('points-amount').value);
    const reason = document.getElementById('points-reason').value;
    
    if (!userId || isNaN(points) || points <= 0) {
      alert('يرجى إدخال عدد نقاط صحيح');
      return;
    }
    
    try {
      // تحميل بيانات المستخدم الحالية
      const userData = await app.getUserDetails(userId);
      if (!userData) {
        alert('لم يتم العثور على المستخدم');
        return;
      }
      
      // تحديث النقاط
      const newPoints = (userData.points || 0) + points;
      await update(ref(database, 'users/' + userId), {
        points: newPoints
      });
      
      // تسجيل عملية إضافة النقاط
      const pointsHistoryRef = ref(database, 'pointsHistory/' + userId);
      const newHistoryRef = push(pointsHistoryRef);
      await set(newHistoryRef, {
        points: points,
        reason: reason,
        addedBy: app.currentUser.uid,
        addedByName: app.userData.name,
        timestamp: new Date().toISOString()
      });
      
      // التحقق من ترقية الرتبة
      await this.checkRankPromotion(userId, newPoints);
      
      alert(`تم إضافة ${points} نقطة إلى المستخدم بنجاح`);
      document.getElementById('add-points-modal').style.display = 'none';
      document.getElementById('points-amount').value = '';
      document.getElementById('points-reason').value = '';
      
      // إعادة تحميل البيانات
      this.loadManagementData();
      
    } catch (error) {
      console.error("Error adding points:", error);
      alert('حدث خطأ أثناء إضافة النقاط');
    }
  }

  async checkRankPromotion(userId, newPoints) {
    try {
      const userData = await app.getUserDetails(userId);
      if (!userData) return;
      
      const currentRank = userData.rank || 0;
      let newRank = currentRank;
      
      // التحقق من شروط الترقية
      if (currentRank === 0 && newPoints >= 100) {
        newRank = 1; // ترقية إلى رتبة عضو
      } else if (currentRank >= 1 && currentRank < 5) {
        // للرتب الأعلى، نتحقق من وجود 3 أشخاص في الفريق برتبة أقل بمستوى واحد
        const hasEnoughTeamMembers = await this.checkTeamRankRequirements(userId, currentRank + 1);
        if (hasEnoughTeamMembers) {
          newRank = currentRank + 1;
        }
      }
      
      // إذا تغيرت الرتبة، نقوم بالتحديث
      if (newRank !== currentRank) {
        await update(ref(database, 'users/' + userId), {
          rank: newRank
        });
        
        // تسجيل الترقية
        const promotionHistoryRef = ref(database, 'promotionHistory/' + userId);
        const newPromotionRef = push(promotionHistoryRef);
        await set(newPromotionRef, {
          fromRank: currentRank,
          toRank: newRank,
          timestamp: new Date().toISOString()
        });
        
        alert(`تم ترقية المستخدم إلى الرتبة ${newRank} (${app.getRankTitle(newRank)})`);
      }
    } catch (error) {
      console.error("Error checking rank promotion:", error);
    }
  }

  async checkTeamRankRequirements(userId, targetRank) {
    try {
      // الحصول على جميع أعضاء فريق المستخدم
      const teamMembers = [];
      await this.loadTeamMembers(userId, teamMembers, 0, 5);
      
      // عد عدد الأعضاء الذين لديهم الرتبة المطلوبة (الرتبة المستهدفة - 1)
      const requiredRank = targetRank - 1;
      const qualifiedMembers = teamMembers.filter(member => 
        (member.rank || 0) >= requiredRank
      );
      
      // يجب أن يكون هناك 3 أعضاء على الأقل بالرتبة المطلوبة
      return qualifiedMembers.length >= 3;
    } catch (error) {
      console.error("Error checking team rank requirements:", error);
      return false;
    }
  }

  async loadTeamMembers(userId, teamMembers, currentLevel, maxLevel) {
    if (currentLevel > maxLevel) return;
    
    try {
      // تحميل الإحالات المباشرة لهذا المستخدم
      const referralsRef = ref(database, 'userReferrals/' + userId);
      const snapshot = await get(referralsRef);
      
      if (snapshot.exists()) {
        const referrals = snapshot.val();
        
        for (const referredUserId in referrals) {
          // تحميل بيانات المستخدم المفصلة
          const userRef = ref(database, 'users/' + referredUserId);
          const userSnapshot = await get(userRef);
          
          if (userSnapshot.exists()) {
            const userData = userSnapshot.val();
            
            // إضافة العضو إلى القائمة
            teamMembers.push({
              ...userData,
              level: currentLevel + 1,
              id: referredUserId
            });
            
            // تحميل الإحالات بشكل متكرر
            await this.loadTeamMembers(referredUserId, teamMembers, currentLevel + 1, maxLevel);
          }
        }
      }
    } catch (error) {
      console.error("Error loading team members:", error);
    }
  }
}

// تهيئة نظام الإدارة عند تحميل الصفحة
let management;
document.addEventListener('DOMContentLoaded', function() {
  management = new Management();
  window.management = management;
});

// إغلاق النوافذ المنبثقة
document.addEventListener('DOMContentLoaded', function() {
  // إغلاق نافذة إضافة النقاط
  const pointsModal = document.getElementById('add-points-modal');
  if (pointsModal) {
    const closeBtn = pointsModal.querySelector('.close');
    closeBtn.addEventListener('click', function() {
      pointsModal.style.display = 'none';
    });
    
    // إغلاق النافذة عند النقر خارج المحتوى
    window.addEventListener('click', function(event) {
      if (event.target === pointsModal) {
        pointsModal.style.display = 'none';
      }
    });
  }
});